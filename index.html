<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no">
	<title>Biking tour of Anchorage Breweries</title>
	<style>
		html, body, #map-canvas {
			height: 100%;
			margin: 0px;
			padding: 0px
		}
		#panel {
			position: absolute;
			top: 5px;
			left: 50%;
			margin-left: -180px;
			z-index: 5;
			background-color: #fff;
			padding: 10px;
			border: 1px solid #999;
		}
		details {
			background-color: rgba(0, 0, 0, 0.75);
			border: 1px solid rgb(0, 0, 0);
			position: absolute;
			padding: 10px;
			top: 62px;
			left: 10px;
			z-index: 6;
			font-family: sans-serif;
			color: white;
		}
		summary {
			margin: 10px 0;
		}
		#menu button{
			display: block;
			margin: 10px;
			width: 100px;
		}
	</style>
</head>
<body>
	<div id="map-canvas"></div>
	<details>
		<summary>Choose your breweries</summary>
		<div id="menu"></div>
	</details>

	<script>
		// Global variables - declared but not initialized until API loads
		let map, bikeLayer, directionsDisplay, directionsService, infowindow;
		let waypoints = [];
		let markers = [];
		let start_finish = {};

		const directionsDisplayOptions = {
			preserveViewport: true,
			suppressMarkers: true,
			suppressBicyclingLayer: true
		};

		const DEFAULT_WAYPOINTS = [
			{
				name: "Glacier Brewhouse",
				address: "737 W 5th Ave Ste. 110, Anchorage, AK 99501",
				latlong: { lat: 61.21757050000001, lng: -149.8964654 }
			},
			{
				name: "49th State Brewing Co.",
				address: "717 W 3rd Ave, Anchorage, AK 99501",
				latlong: { lat: 61.2195394, lng: -149.8958217 }
			},
			{
				name: "Mooses Tooth Pub & Pizzeria",
				address: "3300 Old Seward Hwy, Anchorage, AK",
				latlong: { lat: 61.19068459999999, lng: -149.8682844 }
			},
			{
				name: "Onsite Brewing",
				address: "3211 Denali St, Anchorage, AK 99503",
				latlong: { lat: 61.1913606, lng: -149.8764497 }
			},
			{
				name: "Double Shovel Cider Company",
				address: "502 W 58th Ave C, Anchorage, AK 99518",
				latlong: { lat: 61.168699, lng: -149.8916839 }
			},
			{
				name: "Ship Creek Brewing Company",
				address: "5801 Arctic Blvd, Anchorage, AK 99518",
				latlong: { lat: 61.168644968405815, lng: -149.89713729786095 }
			},
			{
				name: "Brewerks",
				address: "625 W 59th Ave, Units A/B, Anchorage, AK 99518",
				latlong: { lat: 61.1675884, lng: -149.8944055 }
			},
			{
				name: "Cynosure Brewing",
				address: "1363, 144 E Potter Dr unit e, Anchorage, AK 99518",
				latlong: { lat: 61.16843006357235, lng: -149.88195739135773 }
			},
			{
				name: "Turnagain Brewing",
				address: "7920 & 7924 King Street, Anchorage, Alaska 99518",
				latlong: { lat: 61.14904, lng: -149.878212 }
			},
			{
				name: "Zip Kombucha",
				address: "8161 Schoon Street, Anchorage, Alaska 99518",
				latlong: { lat: 61.14728812592769, lng: -149.87438178351474 }
			},
			{
				name: "Midnight Sun Brewing Co.",
				address: "8111 Dimond Hook Dr, Anchorage, AK 99507",
				latlong: { lat: 61.1469204, lng: -149.84449940000002 }
			},
			{
				name: "Magnetic North Brewing Co",
				address: "8861 Golovin St, Anchorage, AK 99507",
				latlong: { lat: 61.1404826, lng: -149.8372688 }
			},
			{
				name: "Anchorage Brewing Company",
				address: "148 West 91st Street, Anchorage, AK 99515",
				latlong: { lat: 61.1388234, lng: -149.8815848 }
			},
			{
				name: "King Street Brewing Company",
				address: "9050 King St, Anchorage, AK 99515",
				latlong: { lat: 61.1389589, lng: -149.8799729 }
			},
			{
				name: "Ravens Ring Brewing Company",
				address: "12150 Industry Way Unit Q-1, Anchorage, AK 99515",
				latlong: { lat: 61.1107670510692, lng: -149.86213252689595 }
			}
		];

		// Function to create a beer icon element
		function createBeerIcon() {
			const beerIcon = document.createElement('div');
			beerIcon.innerHTML = 'üç∫';
			beerIcon.style.fontSize = '24px';
			beerIcon.style.cursor = 'pointer';
			// Keep the emoji visible but add a subtle black outline
			beerIcon.style.textShadow = `
				-1px -1px 0 #000,
				1px -1px 0 #000,
				-1px 1px 0 #000,
				1px 1px 0 #000
			`;
			beerIcon.style.filter = 'drop-shadow(0 2px 4px rgba(0,0,0,0.3))';
			return beerIcon;
		}

		// Build menu once DOM is loaded
		function buildMenu() {
			const menu = document.querySelector('#menu');
			DEFAULT_WAYPOINTS.forEach(function(waypoint, index) {
				const input = document.createElement('input');
				input.type = 'checkbox';
				input.onchange = loadPath;
				input.value = index;
				input.checked = true;
				menu.appendChild(input);
				menu.append(waypoint.name);
				menu.append(document.createElement('br'));
			});
		}

		async function initMap() {
			try {
				console.log('Loading Google Maps libraries...');
				
				// Import all required libraries
				const { Map } = await google.maps.importLibrary("maps");
				const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");
				const { DirectionsService, DirectionsRenderer } = await google.maps.importLibrary("routes");
				
				console.log('Libraries loaded successfully');

				// Create map
				const mapOptions = {
					zoom: 12,
					center: { lat: 61.180610, lng: -149.868374 },
					mapId: '8749f53d22ead1358cdcc5c0'
				};
				
				map = new Map(document.getElementById('map-canvas'), mapOptions);
				console.log('Map created');

				// Initialize services
				directionsDisplay = new DirectionsRenderer(directionsDisplayOptions);
				directionsService = new DirectionsService();
				infowindow = new google.maps.InfoWindow({
					size: new google.maps.Size(150,50)
				});
				
				console.log('Services initialized');

				// Add bike layer
				bikeLayer = new google.maps.BicyclingLayer();
				bikeLayer.setMap(map);

				// Create markers
				DEFAULT_WAYPOINTS.forEach(function(waypoint, index) {
					const marker = new AdvancedMarkerElement({
						position: waypoint.latlong,
						map: map,
						content: createBeerIcon(),
						title: waypoint.name
					});

					marker.addListener('click', function() {
						infowindow.setContent('<b>' + waypoint.name + '</b><br>' + waypoint.address);
						infowindow.open(map, marker);
					});
					
					markers.push(marker);
				});

				console.log('Markers created');

				// Load initial path
				loadPath();
				
				console.log('Map initialization complete');
				
			} catch (error) {
				console.error('Error initializing map:', error);
			}
		}

		function loadPath() {
			if (!directionsDisplay || !directionsService) {
				console.log('DirectionsService not ready yet');
				return;
			}

			clearRoute();

			// Find checked breweries
			waypoints = [];
			document.querySelectorAll('input:checked').forEach(function(input) {
				waypoints.push(DEFAULT_WAYPOINTS[parseInt(input.value)]);
			});

			if (waypoints.length > 0) {
				start_finish = waypoints[0];
				directionsDisplay.setMap(map);
				calcRoute(start_finish, waypoints[waypoints.length - 1], waypoints);
			}

			// Show/hide markers
			document.querySelectorAll('input').forEach(function(input, index) {
				if (markers[index]) {
					markers[index].map = input.checked ? map : null;
				}
			});
		}

		function calcRoute(start, end, routes) {
			if (!directionsService) return;
			
			const waypts = [];
			for (let i = 1; i < routes.length - 1; i++) {
				waypts.push({
					location: routes[i].address,
					stopover: true
				});
			}
			
			const request = {
				origin: start.address,
				destination: end.address,
				waypoints: waypts,
				optimizeWaypoints: false,
				travelMode: google.maps.TravelMode.BICYCLING,
				avoidHighways: true
			};
			
			directionsService.route(request, function(response, status) {
				if (status === google.maps.DirectionsStatus.OK) {
					directionsDisplay.setDirections(response);
				} else {
					console.error('Directions request failed:', status);
				}
			});
		}

		function clearRoute() {
			if (directionsDisplay) {
				directionsDisplay.setMap(null);
			}
		}

		// Load Google Maps API
		(g=>{var h,a,k,p="The Google Maps JavaScript API",c="google",l="importLibrary",q="__ib__",m=document,b=window;b=b[c]||(b[c]={});var d=b.maps||(b.maps={}),r=new Set,e=new URLSearchParams,u=()=>h||(h=new Promise(async(f,n)=>{await(a=m.createElement("script"));e.set("libraries",[...r]+"");for(k in g)e.set(k.replace(/[A-Z]/g,t=>"_"+t[0].toLowerCase()),g[k]);e.set("callback",c+".maps."+q);a.src=`https://maps.googleapis.com/maps/api/js?`+e;d[q]=f;a.onerror=()=>h=n(Error(p+" could not load."));a.nonce=m.querySelector("script[nonce]")?.nonce||"";m.head.append(a)}));d[l]?console.warn(p+" only loads once. Ignoring:",g):d[l]=(f,...n)=>r.add(f)&&u().then(()=>d[l](f,...n))})
		({key:"AIzaSyAIMb67sJ28dMu_z2MCKYtxeMg0y2NMJCw",v:"weekly"});

		// Initialize everything when DOM is ready
		document.addEventListener('DOMContentLoaded', function() {
			buildMenu();
			initMap();
		});
	</script>
</body>
</html>
